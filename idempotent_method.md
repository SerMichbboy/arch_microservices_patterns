# –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö

**–ò–¥–µ–º–ø–æ—Ç–µÃÅ–Ω—Ç–Ω–æ—Å—Ç—å** (–æ—Ç –ª–∞—Ç. *idem* ‚Äî ¬´—Ç–æ—Ç –∂–µ —Å–∞–º—ã–π¬ª + *potens* ‚Äî ¬´—Å–ø–æ—Å–æ–±–Ω—ã–π¬ª)  
‚Äî —ç—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –¥–∞—ë—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —á—Ç–æ –∏ –ø–µ—Ä–≤—ã–π.

---

## üî• –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

1. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã**  
   –°–µ—Ç—å –Ω–µ–Ω–∞–¥—ë–∂–Ω–∞: –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è, —Ç–∞–π–º–∞—É—Ç–Ω—É—Ç—å—Å—è –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –¥–≤–∞–∂–¥—ã.  
   –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä –Ω–µ –ø–æ—Ä—Ç–∏—Ç –¥–∞–Ω–Ω—ã–µ.

   **–ü—Ä–∏–º–µ—Ä:**  
   `PUT /user/1 { "name": "Sergo" }`  
   –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –Ω–µ –æ—Ç–ø—Ä–∞–≤—å ‚Üí –∏–º—è –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç `"Sergo"`.

---

2. **–£–ø—Ä–æ—â–∞–µ—Ç retry-–º–µ—Ö–∞–Ω–∏–∫—É**  
   –ö–ª–∏–µ–Ω—Ç/—Å–µ—Ä–≤–∏—Å –º–æ–∂–µ—Ç —Ä–µ—Ç—Ä–∞–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –±–µ–∑ —Ä–∏—Å–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.  
   –í –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö —á–µ—Ä–µ–∑ Kafka –∏–ª–∏ Celery —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –¥–≤–∞–∂–¥—ã ‚Äî –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

---

3. **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**  
   –î–∞–∂–µ –ø—Ä–∏ —Å–±–æ–µ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—ã–∑–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π ‚Üí –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º–∏.

---

4. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**  
   –ú–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –≤—ã–∑–æ–≤ 1, 2 –∏–ª–∏ 10 —Ä–∞–∑ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤.

---

5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API (REST)**  
   –í —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ HTTP:
   - `GET`, `PUT`, `DELETE` ‚Üí **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ**
   - `POST` ‚Üí **–Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π** (–∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å)

---

## ‚öôÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –≤ FastAPI

–ò—Å–ø–æ–ª—å–∑—É–µ–º Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ `Idempotency-Key`.

```python
from fastapi import APIRouter, Request
from redis.asyncio import Redis
import json

redis = Redis(host="localhost", port=6379, db=0)

class IdempotentAPIRouter(APIRouter):
    def add_api_route(self, path: str, endpoint, **kwargs):
        async def wrapper(request: Request, *args, **kw):
            key = request.headers.get("Idempotency-Key")
            if not key:
                # –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω ‚Üí –æ–±—ã—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                return await endpoint(request, *args, **kw)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            cached = await redis.get(key)
            if cached:
                return json.loads(cached)

            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
            result = await endpoint(request, *args, **kw)

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 1 —á–∞—Å
            await redis.setex(key, 3600, json.dumps(result))
            return result

        super().add_api_route(path, wrapper, **kwargs)


router = IdempotentAPIRouter()

@router.post("/pay")
async def pay(request: Request):
    body = await request.json()
    return {"order": body["orderId"], "status": "paid"}

```

‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è (DRY).

–õ–µ–≥–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ TTL –∏ –ø—Ä–∞–≤–∏–ª –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.

–†–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö ‚Üí –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫: —Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
